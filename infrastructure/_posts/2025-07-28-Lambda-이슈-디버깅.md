---
layout: post
title: mysqldump Lambda 자동화 실패 원인 분석 및 해결기
image: 
  path: /assets/img/blog/lambda.png
#description: >
#  Version 9 is the most complete version of Hydejack yet.
#  Modernized design, big headlines, and big new features.
sitemap: false
---

Lambda 이슈 디버깅
{:.lead}

회사 Lambda 오류 발생 원인과 디버깅 과정

- Table of Contents
{:toc .large-only}

### Problem

FE 개발자 분들의 Test dummy data를 위해 dev DB의 mysqldump를 S3에 저장하는 작업을 Lambda로 자동화 해두고 있습니다.
최근 에러로 인해 Lambda가 실패했는데 Cloudwatch 로그로 확인한 원인은 Event bridge에 lambda alias를 설정하지 않아 
default environment variable로 실행된 것에 있었습니다. 
이후 alias를 설정했음에도 Cloudwatch에 로그가 찍히지 않아 확인해보니 Event bridge가 Lambda를 트리거 하지 않는 문제가 있었습니다.

### Solving

찾아보니 Event bridge에 alias에 접근할 권한을 부여하지 않은 것 때문에 트리거 되지 않을 수 있다고 했습니다. Event bridge Role의 Permission policies
를 확인하니 "Resource" 부분에 arn 이름 마지막에 alias 이름이나 asterisk 없이 lambda 함수명으로 끝나있었습니다. Postfix로 alias까지 접근할 수 있도록
asterisk(`'*'`)를 붙여주니 dev 환경 배포 시 Lambda가 도는 것을 확인할 수 있었습니다. AWS는 상당 수 문제가 VPC Security나 IAM policy 때문에
발생하는 것 같습니다. 앞으로 문제를 마주한다면 우선적으로 이 두 가지 파트를 디버깅 해보는 것도 시간을 줄일 수 있으리라 생각합니다.
이상 Lambda 함수 디버깅 과정 공유를 마칩니다 :)

예시 (잘못된 형태):
```json
"Resource": "arn:aws:lambda:ap-northeast-2:123456789012:function:mysqldump"
```

(수정된 형태):
```json
"Resource": "arn:aws:lambda:ap-northeast-2:123456789012:function:mysqldump:*"
```


