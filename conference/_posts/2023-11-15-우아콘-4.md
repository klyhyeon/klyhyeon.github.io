---
layout: post
title: 배민스토어에 최신 기술 한방에 때려넣기 - Kotlin, Spring WebFlux, EDA
image: 
  path: /assets/img/blog/new_years_card_297_2023_a.jpg
#description: >
#  Version 9 is the most complete version of Hydejack yet.
#  Modernized design, big headlines, and big new features.
sitemap: false
---

배민스토어에 최신 기술 한방에 때려넣기: Kotlin, Spring WebFlux, EDA - 김민태, 오지산 (배민스토어서비스개발팀)
{:.lead}

배민스토어는 올해 4월, 레거시 코드와 아키텍처를 전부 재작성하고 재설계하는 빅뱅을 겪었습니다.
그 과정에서 생산성과 효율성을 높이기 위해 여러 가지 기술을 한 번에 도입했고, 다양한 시행착오를 겪었습니다.

배민스토어의 전시 도메인 개발자들이 어떤 일을 하는지 소개하면서,
Kotlin, Spring WebFlux, EDA 도입의 이유와 좋았던 점, 나빴던 점,
그리고 각 기술에 대한 개발자들의 생각까지 날것으로 풀어내 보겠습니다.

CRUD 중 Read가 많은 서비스

- Table of Contents
{:toc .large-only}

### EDA(이벤트 기반 아키텍처)

- 이벤트는 발생한 있는 사실 그 자체
- 이벤트라는 것은 변경이 불가
- ex. 장바구니, 주문, 쿠폰적용, 알ㄹ림 배송시작, 도착

- 장단점이 동시에 있는 아키텍처
- 시스템 간 느슨하게 결합
- 확정성
- 도메인에 특화된 데이터 모델
- 아키텍처 구성 난이도 높음
- 쿠폰 이벤트 -> 쿠폰 consumer 이벤트 수집, 데이터 저장, API 서버: 데이터 조회 -> 데이터 노출
- 상품 이벤트 제로 페이로드 방식

이벤트 활용기
- 이벤트를 시스템에 따라 효율적으로 적용
- 발행 이벤트 순서 역전이 발생되는 경우가 있음
- 이벤트 순서를 계산하고 데이터 저장 vs 마지막의 데이터를 조회하는 것
- 이베느를 연동하면서 확인


데이터 구성방식
- 각 이벤트는 도메인별로 크기가 다름
- shopID 기준으로 데이터를 모아서 조회(NoSQL)
- 도메인 이벤트 -> 카프카 -> consumer -> dynamo DB 적재 -> redis 적재

결론: 변화된 아키텍처 기반으로 전시에 최적화 되어있는 DB를 구성하여 API 호출을 감소시킴

후기
- 이벤트 종류가 너무 많음
- 상품, 셀러, 가게, 쿠폰, 프로모션 등등
- 전시 관련 도메인만 10개 이상
- 이벤트 개수가 많음
- N천만건 이상을 수집, 재고 이벤트는 현재 N억 건 발행
- 그 외에 연동 데이터들도 존재
- 에러와 이벤트 개수가 변동 잦음
- 실시간으로 데이터를 수집하지만 일정 부분 딜레이 존재
- ㅌㄱ정 컨슈머들이 정상적으로 동작하지 않는다면 이벤트가 밀림
- 배치는 엔지니어가 수기로 발행하기도 함

- DLT, 서킷 브레이커 도입

도입 전 고려해봐
- 개발기간, 많은 이점
- 비즈니스에 기술을 맞추어야 함


## 배민스토어 일반셀러 프로젝트를 진행하며 코드, API 새로 도입하며 새로운 기술도입

- Kotlin은 무리없음
- Project Reactor 러닝커브가 높음

WebFlux: 패러다임의 변화
- 그럼에도 도입한 이유, 사내 외부 API 실시간 호출 시 논블로킹하면 스레드 점유하지 않고 기다리는 시간동안 다른 호출가능, 병렬
- 도입 논의 결론: 전시 API만 도입, 어드민, 워커쪽(배치)쪽은 굳이 필요하지 않음 
- mono.zip을 이용해 병렬적으로 처리
- 성능, 효율성 측면에서 변인이 통제된 자료를 만들어 두지 못함

Project Reactor는 이겨내는 중
- api보다 batch에 배압이 중요하지 않을까
- 모니터링으로 pinpoint 사용중인데 이슈 보기 어려움

Kotlin
- 확장함수 - 서비스 내 일괄적으로 잘 사용, 잘 사용하면 DSL 가능 (검색 플랫폼에 사용)
- DSL 문법 오류에 취약
  - 코틀린 DSL로 작성함 - 타입 안전하게 작성가능